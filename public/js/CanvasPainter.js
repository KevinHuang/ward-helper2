var ischool=ischool||{};ischool.WindowResizeHandler={};ischool.WindowResizeHandler.handle=function(f){var b=new Date(1,1,2E3,12,0,0),d=!1;$(window).resize(function(){b=new Date;!1===d&&(d=!0,setTimeout(g,200))});var g=function(){200>new Date-b?setTimeout(g,200):(d=!1,f&&f())}};ischool=ischool||{};ischool.CanvasResizer={};
ischool.CanvasResizer.handle=function(f){var b=f.containerID,d=f.afterResizedHandler,g=0,e=0;ischool.WindowResizeHandler.handle(function(){c()});var c=function(){g=$("#"+b).width()-3;e=$("#"+b).height()-3;var a=g,c=e;$("#"+b).html("");$("<canvas id='myCanvas' width='"+a+"' height='"+c+"' style='padding: 0px; margin: 0px; border: 0px; overflow: hidden;'></canvas>").appendTo("#"+b);d&&d()};c()};ischool=ischool||{};ischool.StrokePlayer={};
ischool.StrokePlayer.create=function(f){var b=[],d=[],g=100,e=1,c;ischool.CanvasResizer.handle({containerID:f,widthDiff:0,heightDiff:0,afterResizedHandler:function(){h&&h();c&&c()}});var a=function(){for(var b=!1,a=0,a=0;a<d.length;a++)if(item=d[a],1==item.getStatus()){b=!0;break}if(!b)for(a=0;a<d.length;a++)if(item=d[a],0==item.getStatus()){item.draw(e,g);break}},h=function(){$(b).each(function(a,b){if(b&&0<b.points.length){var d=document.getElementById("myCanvas").getContext("2d");d.beginPath();
d.lineWidth=b.pen;d.strokeStyle=b.color;var c=b.points[0];d.moveTo(c.x,c.y);$(b.points).each(function(b,a){d.lineTo(a.x,a.y);d.stroke()})}})};return{play:function(c,f,h){this.clean();this.stop();c&&(b=c,d=[],$(b).each(function(b,c){var k=StrokePainter("myCanvas",c,a);k&&d.push(k)}),h&&(g=h),f&&(e=f),a())},clean:function(){var a=document.getElementById("myCanvas");a.getContext("2d").clearRect(0,0,a.width,a.height)},drawNow:function(a){this.clean();b=a;h()},stop:function(){for(i=0;i<d.length;i++)item=
d[i],2!=item.getStatus()&&item.stop()},getStrokeCount:function(){return b.length},addStroke:function(c){b.push(c);0!=c.points.length&&((c=StrokePainter("myCanvas",c,a))&&d.push(c),a())},getCanvasID:function(){return"myCanvas"},setCanvasResizeHandler:function(a){c=a},setBackgroundImage:function(a){var b=$("#"+f);a.color&&b.css("background-color",a.color);a.imageUrl&&b.css("background-image","url("+a.imageUrl+")");a.repeat&&b.css("background-repeat",a.repeat);a.position&&b.css("background-position",
a.position);a.size&&b.css("background-size",a.size)}}};
var StrokePainter=function(f,b,d){if(!b||0==b.points.length)return null;var g=0,e,c=b.points,a=0,h=b.color,k=b.pen,l=c[0],p=l.time,m,r=1,s=100,q=!1,v=function(){g=1;m||(m=(new Date).getTime());e||(e=document.getElementById(f).getContext("2d"),e.beginPath(),e.lineWidth=k,e.strokeStyle=h,e.moveTo(l.x,l.y),console.log(" move to ("+l.x+","+l.y+")"));console.log(" == beginDraw ==  currentIndex : "+a);if(0!=c.length&&!(a>c.length-1)){for(var b=a,t=((new Date).getTime()-m)*r,b=a;b<c.length;b++){if(q){g=
2;console.log(" == isInterrupted ==  currentIndex : "+a);d&&d();return}var n=c[b],u=n.time-p;if(u<t)e.lineTo(n.x,n.y),e.stroke(),console.log(b+" : ("+n.x+","+n.y+") , count :"+c.length+","+u+","+t);else break}b>=c.length?(g=2,d&&d()):(a=b,window.setTimeout(v,s))}};return{draw:function(a,b){r=a;s=b;q=!1;v()},getStatus:function(){return g},stop:function(){q=!0}}};
$.fn.drawTouch=function(f){var b=$.extend({onDrawing:null,onStart:null,onEnd:null,lineWidth:4,lineColor:"#000000"},f);return this.each(function(){var d=this.getContext("2d");d.lineWidth=b.lineWidth;var g=$(this).offset().left,e=$(this).offset().top;$(this).touchstart(function(c){var a=c.originalEvent.changedTouches[0];d.beginPath();d.lineJoin="round";d.lineCap="round";c=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);d.moveTo(c,a);if(b.onStart)b.onStart();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),
x:c,y:a})});$(this).touchmove(function(c){var a=c.originalEvent.changedTouches[0];c.preventDefault();c=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);d.lineTo(c,a);d.strokeStyle=b.lineColor;d.stroke();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),x:c,y:a})});$(this).touchend(function(d){if(b.onEnd)b.onEnd()})})};
$.fn.drawMouse=function(f){var b=$.extend({onDrawing:null,onStart:null,onEnd:null,lineWidth:4,lineColor:"#000000"},f);return this.each(function(){var d=this.getContext("2d");d.lineWidth=b.lineWidth;var g=$(this).offset().left,e=$(this).offset().top,c=0;$(this).mousedown(function(a){c=1;d.beginPath();d.lineJoin="round";d.lineCap="round";var f=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);d.moveTo(f,a);if(b.onStart)b.onStart();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),x:f,y:a})});$(this).mousemove(function(a){if(c){var f=
Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);d.lineTo(f,a);d.strokeStyle=b.lineColor;d.stroke();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),x:f,y:a})}});$(this).mouseup(function(a){c=0;if(b.onEnd)b.onEnd()})})};ischool=ischool||{};ischool.Painter={};
ischool.Painter.create=function(f){var b=f.penSize,d=f.penColor,g=f.afterStroke,e=ischool.StrokePlayer.create(f.containerID);e.setCanvasResizeHandler(function(){l();p();e.drawNow(a)});var c=e.getCanvasID(),a=[],h=[],k=[],l=function(){$("#"+c).drawMouse({lineWidth:b,lineColor:d,onStart:function(a){k=[]},onDrawing:function(a){k.push(a)},onEnd:function(){var c={color:d,pen:b,points:k};a.push(c);h=[];g&&g(c)}})},p=function(){$("#"+c).drawTouch({lineWidth:b,lineColor:d,onStart:function(a){k=[]},onDrawing:function(a){k.push(a)},
onEnd:function(){var c={color:d,pen:b,points:k};a.push(c);h=[];g&&g(c)}})},m=function(){$("#"+c).drawMouse({lineWidth:b,lineColor:d});$("#"+c).drawTouch({lineWidth:b,lineColor:d})};return{replay:function(b){e.play(a,b,10)},undo:function(){e.clean();var b=a.pop();b&&h.push(b);e.drawNow(a)},redo:function(){e.clean();var b=h.pop();b&&a.push(b);e.drawNow(a)},clean:function(){e.clean();a=[];h=[]},getStrokes:function(){return a},setStrokes:function(b){a=b},setPenColor:function(a){d=a;m()},setPenSize:function(a){b=
a;m()},getStrokePlayer:function(){return e},setBackgroundImage:function(a){e.setBackgroundImage(a)}}};