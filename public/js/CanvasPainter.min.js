var ischool=ischool||{};ischool.WindowResizeHandler={};ischool.WindowResizeHandler.handle=function(f){var b=new Date(1,1,2E3,12,0,0),c=!1;$(window).resize(function(){b=new Date;!1===c&&(c=!0,setTimeout(g,200))});var g=function(){200>new Date-b?setTimeout(g,200):(c=!1,f&&f())}};ischool=ischool||{};ischool.CanvasResizer={};
ischool.CanvasResizer.handle=function(f){var b=f.containerID,c=f.afterResizedHandler,g=0,e=0;ischool.WindowResizeHandler.handle(function(){d()});var d=function(){g=$("#"+b).width()-3;e=$("#"+b).height()-3;var a=g,d=e;$("#"+b).html("");$("<canvas id='myCanvas' width='"+a+"' height='"+d+"' style='padding: 0px; margin: 0px; border: 0px; overflow: hidden;'></canvas>").appendTo("#"+b);c&&c()};d()};
$.fn.drawTouch=function(f){var b=$.extend({onDrawing:null,onStart:null,onEnd:null,lineWidth:4,lineColor:"#000000"},f);return this.each(function(){var c=this.getContext("2d");c.lineWidth=b.lineWidth;var g=$(this).offset().left,e=$(this).offset().top;$(this).on("touchstart",function(d){var a=d.originalEvent.changedTouches[0];c.beginPath();c.lineJoin="round";c.lineCap="round";d=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);c.moveTo(d,a);if(b.onStart)b.onStart();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),
x:d,y:a})});$(this).on("touchmove",function(d){var a=d.originalEvent.changedTouches[0];d.preventDefault();d=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);c.lineTo(d,a);c.strokeStyle=b.lineColor;c.stroke();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),x:d,y:a})});$(this).on("touchend",function(c){if(b.onEnd)b.onEnd()})})};
$.fn.drawMouse=function(f){var b=$.extend({onDrawing:null,onStart:null,onEnd:null,lineWidth:4,lineColor:"#000000"},f);return this.each(function(){var c=this.getContext("2d");c.lineWidth=b.lineWidth;var g=$(this).offset().left,e=$(this).offset().top,d=0;$(this).on("mousedown",function(a){d=1;c.beginPath();c.lineJoin="round";c.lineCap="round";var f=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);c.moveTo(f,a);if(b.onStart)b.onStart();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),x:f,y:a})});$(this).on("mousemove",
function(a){if(d){var f=Math.floor(a.pageX-g);a=Math.floor(a.pageY-e);c.lineTo(f,a);c.strokeStyle=b.lineColor;c.stroke();if(b.onDrawing)b.onDrawing({time:(new Date).getTime(),x:f,y:a})}});$(this).on("mouseup",function(a){d=0;if(b.onEnd)b.onEnd()})})};ischool=ischool||{};ischool.StrokePlayer={};
ischool.StrokePlayer.create=function(f){var b=[],c=[],g=100,e=1,d;ischool.CanvasResizer.handle({containerID:f,widthDiff:0,heightDiff:0,afterResizedHandler:function(){h&&h();d&&d()}});var a=function(){for(var b=!1,a=0,a=0;a<c.length;a++)if(item=c[a],1==item.getStatus()){b=!0;break}if(!b)for(a=0;a<c.length;a++)if(item=c[a],0==item.getStatus()){item.draw(e,g);break}},h=function(){$(b).each(function(a,b){if(b&&0<b.points.length){var c=document.getElementById("myCanvas").getContext("2d");c.beginPath();
c.lineWidth=b.pen;c.strokeStyle=b.color;c.lineJoin="round";c.lineCap="round";var d=b.points[0];c.moveTo(d.x,d.y);$(b.points).each(function(b,a){c.lineTo(a.x,a.y);c.stroke()})}})};return{play:function(d,f,h){this.clean();this.stop();d&&(b=d,c=[],$(b).each(function(b,d){var k=StrokePainter("myCanvas",d,a);k&&c.push(k)}),h&&(g=h),f&&(e=f),a())},clean:function(){var a=document.getElementById("myCanvas");a.getContext("2d").clearRect(0,0,a.width,a.height)},drawNow:function(a){this.clean();b=a;h()},stop:function(){for(i=
0;i<c.length;i++)item=c[i],2!=item.getStatus()&&item.stop()},getStrokeCount:function(){return b.length},addStroke:function(d){b.push(d);0!=d.points.length&&((d=StrokePainter("myCanvas",d,a))&&c.push(d),a())},getCanvasID:function(){return"myCanvas"},setCanvasResizeHandler:function(a){d=a},setBackgroundImage:function(a){var b=$("#"+f);a.color&&b.css("background-color",a.color);a.imageUrl&&b.css("background-image","url("+a.imageUrl+")");a.repeat&&b.css("background-repeat",a.repeat);a.position&&b.css("background-position",
a.position);a.size&&b.css("background-size",a.size)},getImageDataUrl:function(){var a=document.getElementById("myCanvas");if(a)return a.toDataURL("image/png")}}};
var StrokePainter=function(f,b,c){if(!b||0==b.points.length)return null;var g=0,e,d=b.points,a=0,h=b.color,k=b.pen,l=d[0],p=l.time,m,r=1,s=100,q=!1,v=function(){g=1;m||(m=(new Date).getTime());e||(e=document.getElementById(f).getContext("2d"),e.beginPath(),e.lineWidth=k,e.strokeStyle=h,e.lineJoin="round",e.lineCap="round",e.moveTo(l.x,l.y),console.log(" move to ("+l.x+","+l.y+")"));console.log(" == beginDraw ==  currentIndex : "+a);if(0!=d.length&&!(a>d.length-1)){for(var b=a,t=((new Date).getTime()-
m)*r,b=a;b<d.length;b++){if(q){g=2;console.log(" == isInterrupted ==  currentIndex : "+a);c&&c();return}var n=d[b],u=n.time-p;if(u<t)e.lineTo(n.x,n.y),e.stroke(),console.log(b+" : ("+n.x+","+n.y+") , count :"+d.length+","+u+","+t);else break}b>=d.length?(g=2,c&&c()):(a=b,window.setTimeout(v,s))}};return{draw:function(a,b){r=a;s=b;q=!1;v()},getStatus:function(){return g},stop:function(){q=!0}}},ischool=ischool||{};ischool.Painter={};
ischool.Painter.create=function(f){var b=f.penSize,c=f.penColor,g=f.afterStroke,e=ischool.StrokePlayer.create(f.containerID);e.setCanvasResizeHandler(function(){l();p();e.drawNow(a)});var d=e.getCanvasID(),a=[],h=[],k=[],l=function(){$("#"+d).drawMouse({lineWidth:b,lineColor:c,onStart:function(a){k=[]},onDrawing:function(a){k.push(a)},onEnd:function(){var d={color:c,pen:b,points:k};a.push(d);h=[];g&&g(d)}})},p=function(){$("#"+d).drawTouch({lineWidth:b,lineColor:c,onStart:function(a){k=[]},onDrawing:function(a){k.push(a)},
onEnd:function(){var d={color:c,pen:b,points:k};a.push(d);h=[];g&&g(d)}})};l();p();var m=function(){$("#"+d).drawMouse({lineWidth:b,lineColor:c});$("#"+d).drawTouch({lineWidth:b,lineColor:c})};return{replay:function(b){e.play(a,b,10)},undo:function(){e.clean();var b=a.pop();b&&h.push(b);e.drawNow(a)},redo:function(){e.clean();var b=h.pop();b&&a.push(b);e.drawNow(a)},clean:function(){e.clean();a=[];h=[]},getStrokes:function(){return a},setStrokes:function(b){a=b},setPenColor:function(a){c=a;m()},setPenSize:function(a){b=
a;m()},getStrokePlayer:function(){return e},setBackgroundImage:function(a){e.setBackgroundImage(a)},getImageDataUrl:function(){return e.getImageDataUrl()}}};